<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Distributor Dashboard ‚Ä¢ Millet Supply Chain</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    body { background: #f5f7fa; font-family: 'Segoe UI', sans-serif; }
    .navbar { background-color: #e8f5e9; box-shadow: 0 2px 6px rgba(0,0,0,0.05); }
    .navbar-brand { font-weight: bold; font-size: 1.5rem; color: #2e7d32 !important; }
    .sidebar { min-height: 100vh; background: #2e7d32; color: #fff; padding: 1rem; }
    .sidebar a { color: #fff; display: block; margin-bottom: 1rem; text-decoration: none; font-weight: 500; }
    .sidebar a:hover { text-decoration: underline; }
    .card { border: 0; border-radius: 1rem; box-shadow: 0 6px 20px rgba(0,0,0,.05); }
    .card-header { background-color: #e8f5e9; font-weight: 600; }
  </style>
</head>
<body>
<nav class="navbar navbar-expand-lg">
  <div class="container-fluid">
    <a class="navbar-brand d-flex align-items-center" href="#">
      <img src="https://cdn-icons-png.flaticon.com/512/7651/7651380.png" height="36" class="me-2" />
      Distributor Dashboard ‚Äì Millet Supply Chain
    </a>
  </div>
</nav>

<div class="d-flex">
  <div class="sidebar">
    <h4 class="mb-4">üöö Distributor Menu</h4>
    <a href="#" onclick="showSection('stock')">üì¶ My Stock</a>
    <a href="#" onclick="showSection('placeOrder')">üìù Place Order</a>
    <a href="#" onclick="showSection('orderHistory')">üìú Order History</a>
    <a href="#" onclick="showSection('sales')">üí∞ Sales Entry</a>
  </div>

  <div class="flex-grow-1 p-4">

    <!-- My Stock -->
    <div class="card mb-4" id="stock">
      <div class="card-header">üì¶ Current Stock</div>
      <div class="card-body">
        <table class="table table-bordered">
          <thead><tr><th>#</th><th>Product</th><th>SKU</th><th>Qty</th><th>MRP</th></tr></thead>
          <tbody id="stockTable"><tr><td colspan="5" class="text-muted">Loading...</td></tr></tbody>
        </table>
      </div>
    </div>

    <!-- Place Order -->
    <div class="card mb-4" id="placeOrder" style="display:none">
      <div class="card-header">üìù Place New Order</div>
      <div class="card-body">
        <form id="orderForm">
          <div class="row mb-3">
            <div class="col-md-6">
              <label class="form-label">Product</label>
              <select name="productId" class="form-select" required id="productSelect"></select>
            </div>
            <div class="col-md-6">
              <label class="form-label">Quantity</label>
              <input type="number" name="qty" class="form-control" required min="1" />
            </div>
          </div>
          <button type="submit" class="btn btn-success">Place Order</button>
        </form>
      </div>
    </div>

    <!-- Order History -->
    <div class="card mb-4" id="orderHistory" style="display:none">
      <div class="card-header">üìú Order History</div>
      <div class="card-body">
        <table class="table table-striped">
          <thead><tr><th>#</th><th>Product</th><th>Qty</th><th>Status</th><th>Date</th><th>Action</th></tr></thead>
          <tbody id="historyTable"><tr><td colspan="6" class="text-muted">Loading...</td></tr></tbody>
        </table>
      </div>
    </div>

    <!-- Sales Entry -->
    <div class="card" id="sales" style="display:none">
      <div class="card-header">üí∞ Enter Sales</div>
      <div class="card-body">
        <form id="salesForm">
          <div class="row mb-3">
            <div class="col-md-6">
              <label class="form-label">Product</label>
              <select name="productId" class="form-select" required id="salesProduct"></select>
            </div>
            <div class="col-md-6">
              <label class="form-label">Qty Sold</label>
              <input type="number" name="qty" class="form-control" required min="1" />
            </div>
          </div>
          <button type="submit" class="btn btn-success">Record Sale</button>
        </form>
      </div>
    </div>

  </div>
</div>

<script>
const distributorId = localStorage.getItem("distributorId") || 1;
const warehouseId = localStorage.getItem("warehouseId") || 1;

let distributorName = "Distributor";
let productMap = {}; // productId => name

function showSection(id) {
  ['stock', 'placeOrder', 'orderHistory', 'sales'].forEach(s => {
    document.getElementById(s).style.display = s === id ? 'block' : 'none';
  });
  if (id === 'stock') loadStock();
  if (id === 'orderHistory') loadHistory();
  if (id === 'sales') loadSales();
}

document.addEventListener("DOMContentLoaded", () => {
  loadStock();
  loadProductOptions();

  // Load distributor name
  fetch(`https://millet-backend.onrender.com/api/distributor/info?distributorId=${distributorId}`)
  .then(res => {
    if (!res.ok) throw new Error("Invalid distributor");
    return res.json();
  })
  .then(data => {
    distributorName = `${data.name} (${data.warehouse})`;
  })
  .catch(err => {
    console.error("‚ùå Failed to fetch distributor info:", err);
    distributorName = "Unknown Distributor";
  });

  // Load product name mapping for later use
  fetch("https://millet-backend.onrender.com/api/products")
    .then(res => res.json())
    .then(data => {
      data.products.forEach(p => {
        productMap[p.id] = p.name;
      });
    });
});

// üì¶ Load Stock
function loadStock() {
  fetch(`https://millet-backend.onrender.com/api/distributor/stock?distributorId=${distributorId}`)
    .then(res => res.json())
    .then(data => {
      const tbody = document.getElementById("stockTable");
      tbody.innerHTML = "";
      if (!data.stock || data.stock.length === 0) {
        tbody.innerHTML = `<tr><td colspan="5" class="text-center text-muted">No stock found.</td></tr>`;
        return;
      }
      data.stock.forEach((item, i) => {
        tbody.innerHTML += `<tr>
          <td>${i+1}</td>
          <td>${item.productName}</td>
          <td>${item.sku}</td>
          <td>${item.qty}</td>
          <td>‚Çπ${item.mrp}</td>
        </tr>`;
      });
    })
    .catch(err => {
      console.error("‚ùå Error loading stock:", err);
      document.getElementById("stockTable").innerHTML = `<tr><td colspan="5" class="text-danger">Failed to load stock.</td></tr>`;
    });
}

// üì• Load Product Options for Order & Sales forms
function loadProductOptions() {
  fetch(`https://millet-backend.onrender.com/api/products`)
    .then(res => res.json())
    .then(data => {
      const productSelect = document.getElementById("productSelect");
      const salesProduct = document.getElementById("salesProduct");
      productSelect.innerHTML = salesProduct.innerHTML = "";
      data.products.forEach(p => {
        const opt = `<option value="${p.id}">${p.name}</option>`;
        productSelect.innerHTML += opt;
        salesProduct.innerHTML += opt;
      });
    })
    .catch(err => {
      console.error("‚ùå Error loading product options:", err);
    });
}

// üìù Submit Order Form
document.getElementById("orderForm").addEventListener("submit", function(e) {
  e.preventDefault();
  const form = new FormData(this);
  const qty = parseInt(form.get("qty"));
  const productId = form.get("productId");
  const productName = productMap[productId] || `Product ID ${productId}`;

  fetch("https://millet-backend.onrender.com/api/order", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({
      distributor_id: distributorId,
      warehouse_id: warehouseId,
      product_id: productId,
      qty: qty
    })
  }).then(res => res.json())
    .then(data => {
      // Push to activity log
      fetch("https://millet-backend.onrender.com/api/activity-log", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          source: distributorName,
          description: `üìù Placed order for ${qty} units of ${productName}`
        })
      });

      alert("‚úÖ Order placed!");
      this.reset();
      loadHistory();
      showSection('orderHistory');  // Auto switch to order history after placing order
    })
    .catch(err => {
      console.error("‚ùå Error placing order:", err);
      alert("Failed to place order.");
    });
});

// üí∞ Submit Sales Form
document.getElementById("salesForm").addEventListener("submit", function(e) {
  e.preventDefault();
  const form = new FormData(this);
  const qty = parseInt(form.get("qty"));
  const productId = form.get("productId");
  const productName = productMap[productId] || `Product ID ${productId}`;

  fetch("https://millet-backend.onrender.com/api/distributor/sales", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({
      distributorId,
      productId,
      qty
    })
  }).then(res => res.json())
    .then(data => {
      // Push to activity log
      fetch("https://millet-backend.onrender.com/api/activity-log", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          source: distributorName,
          description: `Sold ${qty} units of ${productName}`
        })
      });

      alert("‚úÖ Sale recorded!");
      this.reset();
      loadStock();
      loadSales();
      showSection('stock');  // Switch back to stock after sale
    })
    .catch(err => {
      console.error("‚ùå Error recording sale:", err);
      alert("Failed to record sale.");
    });
});

// üìú Load Order History with Confirm Delivery button for Shipped orders
function loadHistory() {
  fetch(`https://millet-backend.onrender.com/api/distributor/orders?distributorId=${distributorId}`)
    .then(res => res.json())
    .then(data => {
      const tbody = document.getElementById("historyTable");
      tbody.innerHTML = "";

      if (!data.orders || data.orders.length === 0) {
        tbody.innerHTML = `<tr><td colspan="6" class="text-center text-muted">No orders found.</td></tr>`;
        return;
      }

      data.orders.forEach((o, i) => {
        let actionHtml = '';
        if (o.status === "Shipped") {
          actionHtml = `<button class="btn btn-sm btn-primary" onclick="confirmDelivery(${o.id})">Confirm Delivered</button>`;
        } else {
          actionHtml = '‚Äî';
        }

        tbody.innerHTML += `<tr>
          <td>${i + 1}</td>
          <td>${o.productName}</td>
          <td>${o.qty}</td>
          <td>${o.status}</td>
          <td>${new Date(o.date).toLocaleString()}</td>
          <td>${actionHtml}</td>
        </tr>`;
      });
    })
    .catch(err => {
      console.error("‚ùå Error loading order history:", err);
      document.getElementById("historyTable").innerHTML = `<tr><td colspan="6" class="text-danger">Failed to load order history.</td></tr>`;
    });
}

// Confirm delivery button handler
function confirmDelivery(orderId) {
  if (!confirm("Are you sure you want to confirm delivery for this order?")) return;

  fetch('https://millet-backend.onrender.com/api/distributor/confirm-delivery', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ orderId }),
  })
  .then(res => res.json())
  .then(data => {
    if (data.success) {
      alert("‚úÖ Delivery confirmed!");
      loadHistory();
    } else {
      alert("‚ùå Failed to confirm delivery: " + (data.message || "Unknown error"));
    }
  })
  .catch(err => {
    console.error("‚ùå Error confirming delivery:", err);
    alert("‚ùå Network error confirming delivery");
  });
}

// üßæ Load Sales History (Optional, if you want to display sales history)
function loadSales() {
  fetch(`https://millet-backend.onrender.com/api/distributor/sales?distributorId=${distributorId}`)
    .then(res => res.json())
    .then(data => {
      // Add if you want a sales history table somewhere or extend UI here
      // For now, not displayed
      console.log("Sales data loaded", data.sales);
    })
    .catch(err => {
      console.error("‚ùå Error loading sales:", err);
    });
}
</script>

</body>
</html>
